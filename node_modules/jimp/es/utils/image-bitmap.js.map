{"version":3,"sources":["../../src/utils/image-bitmap.js"],"names":["fileType","PNG","JPEG","BMP","UTIF","EXIFParser","GIF","constants","toAGBR","fromAGBR","throwError","MIME","promisify","getMIMEFromBuffer","buffer","path","fileTypeFromBuffer","mime","getType","getBitmapFromGIF","data","gifObj","GifReader","gifData","Buffer","alloc","width","height","decodeAndBlitFrameRGBA","exifRotate","img","exif","_exif","tags","Orientation","mirror","rotate","parseBitmap","cb","Error","_originalMime","toLowerCase","getMIME","MIME_PNG","png","sync","read","bitmap","from","MIME_JPEG","decode","create","parse","err","MIME_TIFF","ifds","page","decodeImages","rgba","toRGBA8","t256","t257","MIME_BMP","MIME_X_MS_BMP","MIME_GIF","call","error","compositeBitmapOverBackground","Jimp","image","_background","composite","getBuffer","AUTO","bitDepth","deflateLevel","_deflateLevel","deflateStrategy","_deflateStrategy","filterType","_filterType","colorType","_rgba","inputHasAlpha","constructor","write","jpeg","encode","_quality","bmp","c","tiff","encodeImage","getBufferAsync"],"mappings":"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","sourcesContent":["import fileType from 'file-type';\n\nimport { PNG } from 'pngjs';\nimport JPEG from 'jpeg-js';\nimport BMP from 'bmp-js';\nimport UTIF from 'utif';\nimport EXIFParser from 'exif-parser';\nimport GIF from 'omggif';\n\nimport * as constants from '../constants';\nimport { toAGBR, fromAGBR } from './abgr';\nimport { throwError } from './error-checking';\nimport * as MIME from './mime';\nimport promisify from './promisify';\n\nfunction getMIMEFromBuffer(buffer, path) {\n    const fileTypeFromBuffer = fileType(buffer);\n\n    if (fileTypeFromBuffer) {\n        // If fileType returns something for buffer, then return the mime given\n        return fileTypeFromBuffer.mime;\n    }\n\n    if (path) {\n        // If a path is supplied, and fileType yields no results, then retry with MIME\n        // Path can be either a file path or a url\n        return MIME.getType(path);\n    }\n\n    return null;\n}\n\n// gets image data from a GIF buffer\nfunction getBitmapFromGIF(data) {\n    const gifObj = new GIF.GifReader(data);\n    const gifData = Buffer.alloc(gifObj.width * gifObj.height * 4);\n\n    gifObj.decodeAndBlitFrameRGBA(0, gifData);\n\n    return {\n        data: gifData,\n        width: gifObj.width,\n        height: gifObj.height\n    };\n}\n\n/*\n * Automagically rotates an image based on its EXIF data (if present)\n * @param img a constants object\n*/\nfunction exifRotate(img) {\n    const exif = img._exif;\n\n    if (exif && exif.tags && exif.tags.Orientation) {\n        switch (img._exif.tags.Orientation) {\n            case 1: // Horizontal (normal)\n                // do nothing\n                break;\n            case 2: // Mirror horizontal\n                img.mirror(true, false);\n                break;\n            case 3: // Rotate 180\n                img.rotate(180, false);\n                break;\n            case 4: // Mirror vertical\n                img.mirror(false, true);\n                break;\n            case 5: // Mirror horizontal and rotate 270 CW\n                img.rotate(-90, false).mirror(true, false);\n                break;\n            case 6: // Rotate 90 CW\n                img.rotate(-90, false);\n                break;\n            case 7: // Mirror horizontal and rotate 90 CW\n                img.rotate(90, false).mirror(true, false);\n                break;\n            case 8: // Rotate 270 CW\n                img.rotate(-270, false);\n                break;\n            default:\n                break;\n        }\n    }\n\n    return img;\n}\n\n// parses a bitmap from the constructor to the JIMP bitmap property\nexport function parseBitmap(data, path, cb) {\n    const mime = getMIMEFromBuffer(data, path);\n\n    if (typeof mime !== 'string') {\n        return cb(new Error('Could not find MIME for Buffer <' + path + '>'));\n    }\n\n    this._originalMime = mime.toLowerCase();\n\n    try {\n        switch (this.getMIME()) {\n            case constants.MIME_PNG: {\n                const png = PNG.sync.read(data);\n\n                this.bitmap = {\n                    data: Buffer.from(png.data),\n                    width: png.width,\n                    height: png.height\n                };\n\n                break;\n            }\n\n            case constants.MIME_JPEG:\n                this.bitmap = JPEG.decode(data);\n\n                try {\n                    this._exif = EXIFParser.create(data).parse();\n                    exifRotate(this); // EXIF data\n                } catch (err) {\n                    /* meh */\n                }\n\n                break;\n\n            case constants.MIME_TIFF: {\n                const ifds = UTIF.decode(data);\n                const page = ifds[0];\n                UTIF.decodeImages(data, ifds);\n                const rgba = UTIF.toRGBA8(page);\n\n                this.bitmap = {\n                    data: Buffer.from(rgba),\n                    width: page.t256[0],\n                    height: page.t257[0]\n                };\n\n                break;\n            }\n\n            case constants.MIME_BMP:\n            case constants.MIME_X_MS_BMP:\n                this.bitmap = BMP.decode(data);\n\n                fromAGBR(this);\n\n                break;\n\n            case constants.MIME_GIF:\n                this.bitmap = getBitmapFromGIF(data);\n                break;\n\n            default:\n                return throwError.call(\n                    this,\n                    'Unsupported MIME type: ' + mime,\n                    cb\n                );\n        }\n    } catch (error) {\n        cb.call(this, error, this);\n    }\n\n    cb.call(this, null, this);\n\n    return this;\n}\n\nfunction compositeBitmapOverBackground(Jimp, image) {\n    return new Jimp(\n        image.bitmap.width,\n        image.bitmap.height,\n        image._background\n    ).composite(image, 0, 0).bitmap;\n}\n\n/**\n * Converts the image to a buffer\n * @param {string} mime the mime type of the image buffer to be created\n * @param {function(Error, Jimp)} cb a Node-style function to call with the buffer as the second argument\n * @returns {Jimp} this for chaining of methods\n */\nexport function getBuffer(mime, cb) {\n    if (mime === constants.AUTO) {\n        // allow auto MIME detection\n        mime = this.getMIME();\n    }\n\n    if (typeof mime !== 'string') {\n        return throwError.call(this, 'mime must be a string', cb);\n    }\n\n    if (typeof cb !== 'function') {\n        return throwError.call(this, 'cb must be a function', cb);\n    }\n\n    switch (mime.toLowerCase()) {\n        case constants.MIME_PNG: {\n            const png = new PNG({\n                width: this.bitmap.width,\n                height: this.bitmap.height,\n                bitDepth: 8,\n                deflateLevel: this._deflateLevel,\n                deflateStrategy: this._deflateStrategy,\n                filterType: this._filterType,\n                colorType: this._rgba ? 6 : 2,\n                inputHasAlpha: true\n            });\n\n            if (this._rgba) {\n                png.data = Buffer.from(this.bitmap.data);\n            } else {\n                // when PNG doesn't support alpha\n                png.data = compositeBitmapOverBackground(\n                    this.constructor,\n                    this\n                ).data;\n            }\n\n            const buffer = PNG.sync.write(png);\n            cb.call(this, null, buffer);\n            break;\n        }\n\n        case constants.MIME_JPEG: {\n            // composite onto a new image so that the background shows through alpha channels\n            const jpeg = JPEG.encode(\n                compositeBitmapOverBackground(this.constructor, this),\n                this._quality\n            );\n            cb.call(this, null, jpeg.data);\n            break;\n        }\n\n        case constants.MIME_BMP:\n        case constants.MIME_X_MS_BMP: {\n            // composite onto a new image so that the background shows through alpha channels\n            toAGBR(this);\n\n            const bmp = BMP.encode(\n                compositeBitmapOverBackground(this.constructor, this)\n            );\n            cb.call(this, null, bmp.data);\n            break;\n        }\n\n        case constants.MIME_TIFF: {\n            const c = compositeBitmapOverBackground(this.constructor, this);\n            const tiff = UTIF.encodeImage(c.data, c.width, c.height);\n            cb.call(this, null, Buffer.from(tiff));\n            break;\n        }\n\n        default:\n            cb.call(this, 'Unsupported MIME type: ' + mime);\n            break;\n    }\n\n    return this;\n}\n\nexport function getBufferAsync(mime) {\n    return promisify(getBuffer, this, mime);\n}\n"],"file":"image-bitmap.js"}